<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Favorite Subjects (å¥½ããªæ•™ç§‘)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

<style>
  /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (ã‚°ãƒªãƒ¼ãƒ³ x ãƒ–ãƒ©ã‚¦ãƒ³) --- */
  :root {
    --bg-color: #f1f8e9;        /* è–„ã„ã‚°ãƒªãƒ¼ãƒ³ */
    --text-color: #4e342e;      /* æ¿ƒã„ãƒ–ãƒ©ã‚¦ãƒ³ */
    --card-bg: #ffffff;
    --accent-green: #558b2f;    /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã®ç·‘ */
    --accent-brown: #795548;    /* ãƒœã‚¿ãƒ³ç­‰ã®ãƒ–ãƒ©ã‚¦ãƒ³ */
    --highlight-bg: #dcedc8;    /* å¼·èª¿ç”¨ã®è–„ç·‘ */
    
    /* ãƒ•ã‚©ãƒ³ãƒˆå®šç¾©: è‹±èªã¨æ—¥æœ¬èªã®ãƒãƒ©ãƒ³ã‚¹ã‚’è€ƒæ…® */
    --main-font: "Zen Maru Gothic", "Hiragino Maru Gothic ProN", "HGMaruGothicMPRO", "Comic Sans MS", sans-serif;
  }

  body {
    font-family: var(--main-font);
    background-color: var(--bg-color);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
    /* PCç‰ˆã®åŸºæº–ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°‘ã—ä¸‹ã’ã¦ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ (20px -> 18px) */
    font-size: 18px; 
  }

  button, input, textarea, .word-btn, .answer-word, .choice-btn {
    font-family: inherit;
    color: var(--text-color);
  }

  h2 {
    color: var(--text-color);
    margin-bottom: 5px;
    text-align: center;
    font-weight: bold;
    border-bottom: 4px dashed var(--accent-brown);
    padding-bottom: 5px;
    display: inline-block;
    font-size: 2rem;
  }
  .sub-title {
    font-size: 1rem;
    color: var(--accent-green);
    margin-bottom: 15px;
    text-align: center;
    font-weight: bold;
  }

  /* ã‚¤ãƒ©ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
  .illustration-container {
    background-color: white;
    padding: 10px;
    border-radius: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    text-align: center;
    max-width: 800px;
    width: 100%;
  }
  .illustration-placeholder {
    width: 100%;
    height: auto;
    max-height: 200px; /* ç”»åƒãŒå¤§ãããªã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
    object-fit: contain;
    border-radius: 10px;
    display: block;
    margin: 0 auto;
  }
  
  .container {
    background: var(--card-bg);
    max-width: 800px; 
    width: 100%;
    padding: 20px;
    border-radius: 30px;
    box-shadow: 0 8px 20px rgba(78, 52, 46, 0.15);
    text-align: center;
    position: relative;
    min-height: 500px;
    border: 4px solid #fff;
  }

  /* ä¸Šéƒ¨ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
  .top-controls {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    gap: 10px;
    z-index: 10;
  }

  .header-btn {
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: bold;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    transition: transform 0.1s;
  }
  .header-btn:active { transform: translateY(2px); box-shadow: none; }
  .print-launch-btn { background-color: var(--accent-brown); }
  .shuffle-btn { background-color: var(--accent-green); }

  /* ã‚²ãƒ¼ãƒ UI */
  .question-header {
      font-size: 1.1rem;
      color: var(--accent-brown);
      margin-bottom: 10px;
      font-weight: bold;
      text-align: left;
      padding-left: 5px;
      display: flex;
      justify-content: space-between;
      border-bottom: 2px solid #efebe9;
      padding-bottom: 5px;
  }
  .q-type-label {
    background-color: var(--accent-green);
    color: white;
    padding: 3px 12px;
    border-radius: 15px;
    font-size: 0.9rem;
  }

  .question-box {
    font-size: 2rem; 
    font-weight: bold;
    margin-bottom: 20px;
    min-height: 120px; 
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #fff8e1;
    border-radius: 15px;
    padding: 20px;
    border: 3px solid #ffe0b2;
    color: var(--text-color);
    line-height: 1.4;
    white-space: pre-wrap;
  }

  /* --- ä¸¦ã¹æ›¿ãˆå•é¡Œç”¨ã‚¨ãƒªã‚¢ --- */
  .sort-area { display: none; }

  .answer-area {
    min-height: 80px;
    border-bottom: 3px solid var(--highlight-bg);
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    padding: 15px;
    background-color: #fafafa;
    border-radius: 15px;
  }
  .word-bank {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  .word-btn {
    background-color: #fff;
    color: var(--text-color);
    border: 2px solid var(--accent-green);
    padding: 10px 20px;
    border-radius: 30px;
    font-size: 1.6rem;
    cursor: pointer;
    transition: all 0.1s;
    user-select: none;
    font-weight: bold;
    box-shadow: 0 3px 0 #c5e1a5;
  }
  .word-btn:active { transform: translateY(3px); box-shadow: none; }
  .word-btn.used { 
    background-color: #eceff1; 
    border-color: #cfd8dc; 
    color: #b0bec5; 
    box-shadow: none; 
    cursor: default; 
    pointer-events: none; 
  }
    
  .answer-word {
    background-color: var(--accent-green);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 1.6rem;
    cursor: pointer;
    animation: popIn 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* --- ç©´åŸ‹ã‚é¸æŠå•é¡Œç”¨ã‚¨ãƒªã‚¢ --- */
  .cloze-area { 
    display: none; 
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .choices-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    width: 100%;
    max-width: 800px; 
  }
  .choice-btn {
    background-color: white;
    border: 3px solid var(--accent-brown);
    color: var(--text-color);
    padding: 15px 10px;
    border-radius: 15px;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
    min-width: 150px; 
    flex: 1; 
  }
  .choice-btn:hover {
    background-color: #efebe9;
    transform: translateY(-4px);
  }
  .choice-btn.selected {
    background-color: var(--accent-brown);
    color: white;
  }
  .choice-btn.correct-choice {
    background-color: var(--accent-green) !important;
    color: white !important;
    border-color: var(--accent-green) !important;
  }
  .choice-btn.wrong-choice {
    background-color: #d32f2f !important;
    color: white !important;
    border-color: #b71c1c !important;
    opacity: 0.7;
  }

  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  .controls { margin-top: auto; padding-top: 10px; }
  button.action-btn {
    padding: 12px 40px;
    font-size: 1.4rem;
    background-color: var(--accent-green);
    color: white;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    box-shadow: 0 5px 0 #33691e;
    font-weight: bold;
    transition: transform 0.1s;
  }
  button.action-btn:active { transform: translateY(5px); box-shadow: none; }
  button.action-btn:hover { background-color: #689f38; }
  
  .result-msg { 
    margin-top: 15px; 
    font-weight: bold; 
    font-size: 1.6rem; 
    min-height: 40px; 
  }
  .correct { color: var(--accent-green); }
  .wrong { color: #c62828; }
  
  .progress-container { width: 100%; background-color: #efebe9; border-radius: 15px; margin-bottom: 15px; height: 12px; overflow: hidden; }
  .progress-bar { height: 100%; background-color: var(--accent-green); width: 0%; transition: width 0.3s; }

  /* å°åˆ·ç”¨ã‚¨ãƒªã‚¢ (ç”»é¢ã§ã¯éè¡¨ç¤º) */
  #printable-sheet { display: none; }

  /* --- ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š --- */
  @media (max-width: 600px) {
    body {
      padding: 10px;
      /* ã‚¹ãƒãƒ›åŸºæº–ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã (14px) */
      font-size: 14px; 
    }
    
    .container {
      padding: 15px 10px; /* æ¨ªå¹…ã‚’æœ‰åŠ¹ã«ä½¿ã†ãŸã‚paddingå‰Šæ¸› */
      min-height: 400px; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è»½æ¸›ã®ãŸã‚é«˜ã•å‰Šæ¸› */
      box-shadow: 0 4px 10px rgba(78, 52, 46, 0.15);
    }

    h2 { font-size: 1.4rem; margin-bottom: 2px; }
    .sub-title { font-size: 0.9rem; margin-bottom: 10px; }
    .top-controls { top: 5px; right: 5px; gap: 5px; }
    .header-btn { padding: 5px 10px; font-size: 0.75rem; }
    
    .illustration-container { margin-bottom: 10px; padding: 5px; }

    /* å•é¡Œæ–‡ã‚¨ãƒªã‚¢: ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
    .question-box {
      font-size: 1.3rem; /* æ–‡å­—ã‚µã‚¤ã‚ºå¤§å¹…ç¸®å° */
      min-height: 70px;  /* é«˜ã•å‰Šæ¸› */
      padding: 15px 10px;
      margin-bottom: 15px;
      line-height: 1.3;
    }

    /* é¸æŠè‚¢: å¼·åˆ¶çš„ã«2åˆ—ã‚°ãƒªãƒƒãƒ‰ã«ã™ã‚‹ */
    .choices-grid {
      display: grid;
      grid-template-columns: 1fr 1fr; /* 1:1ã®2åˆ—å›ºå®š */
      gap: 8px; /* éš™é–“ã‚’ç‹­ã */
      width: 100%;
    }
    .choice-btn {
      min-width: 0; /* Gridå†…ã§ã®ç¸®å°ã‚’è¨±å¯ */
      width: auto;
      font-size: 1.1rem; /* ãƒœã‚¿ãƒ³å†…æ–‡å­—ã‚µã‚¤ã‚ºç¸®å° */
      padding: 12px 2px; /* ä¸Šä¸‹ä½™ç™½ç¢ºä¿ã€å·¦å³ã¯ç‹­ã */
      border-width: 2px;
    }

    /* ä¸¦ã¹æ›¿ãˆã‚¨ãƒªã‚¢ */
    .answer-area {
      min-height: 60px;
      padding: 10px;
      gap: 5px;
    }
    .word-btn, .answer-word {
      font-size: 1.1rem;
      padding: 6px 12px;
      border-width: 2px;
    }
    .word-bank { gap: 8px; margin-bottom: 15px; }

    /* æ“ä½œãƒœã‚¿ãƒ³ */
    button.action-btn {
      font-size: 1.2rem;
      padding: 10px 30px;
    }
    .result-msg {
      font-size: 1.4rem;
      margin-top: 10px;
      min-height: 30px;
    }
  }

  /* --- å°åˆ·æ™‚ã®è¨­å®š (PDF) --- */
  @media print {
    @page { size: A4; margin: 15mm; }
    .container, h2, .sub-title, .top-controls, .illustration-container { display: none !important; }
    
    body { 
      background-color: white; 
      padding: 0; margin: 0; color: black; 
      /* PDFã§ã‚‚ä¸¸ã‚´ã‚·ãƒƒã‚¯ã‚’é©ç”¨ */
      font-family: "Zen Maru Gothic", sans-serif; 
      width: 100%; font-size: 12pt; 
    }
    
    #printable-sheet { display: block; width: 100%; }
    
    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .sheet-header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 15px; padding-bottom: 5px; }
    .sheet-title { font-size: 18pt; font-weight: bold; margin: 0; }
    .sheet-section-title { font-size: 13pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px; padding: 3px 5px; border-left: 5px solid #333; background-color: #f5f5f5; }
    .sheet-question { margin-bottom: 15px; page-break-inside: avoid; }
    .q-text { font-size: 13pt; margin-bottom: 5px; line-height: 1.4; }
    .q-options { font-size: 12pt; margin-left: 15px; font-weight: bold; }
    .q-line { border-bottom: 1px solid #333; height: 35px; width: 100%; margin-bottom: 5px; }
    .word-hint { font-size: 10pt; color: #444; text-align: right; }
    .answer-key-section { page-break-before: always; margin-top: 0; padding-top: 30px; font-size: 11pt; }
    #sheet-answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 30px; }
  }
</style>
</head>
<body>

<div class="top-controls">
  <button class="header-btn shuffle-btn" onclick="initGame(true)">ğŸ”„ æœ€åˆã‹ã‚‰</button>
  <button class="header-btn print-launch-btn" onclick="window.print()">ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ãƒˆã‚’ä½œã‚‹</button>
</div>

<h2>Favorite Subjects</h2>
<div class="sub-title">å¥½ããªæ•™ç§‘ã¯ãªã‚ã«ï¼Ÿ</div>

<div class="illustration-container">
  <img src="favorite subject.jpg" class="illustration-placeholder" alt="Favorite Subjects">
</div>

<div class="container">
  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="question-header">
      <span id="questionNum">Question 1/15</span>
      <span id="questionType" class="q-type-label">ç©´åŸ‹ã‚</span>
  </div>
  
  <div class="question-box" id="questionText">Load Question...</div>
  
  <div class="cloze-area" id="clozeArea">
      <div class="choices-grid" id="choicesGrid"></div>
  </div>

  <div class="sort-area" id="sortArea">
      <div class="answer-area" id="answerArea">
        <span style="color:#8d6e63; font-size:1.2rem; align-self:center;">ã“ã“ã‚’æŠ¼ã—ã¦ ä¸¦ã¹ã¦ã­</span>
      </div>
      <div class="word-bank" id="wordBank"></div>
  </div>

  <div class="result-msg" id="resultMsg"></div>
  
  <div class="controls">
    <button class="action-btn" id="checkBtn" onclick="checkAnswer()">ç­”ãˆåˆã‚ã›</button>
    <button class="action-btn" id="nextBtn" onclick="nextQuestion()" style="display:none; background-color: #ff9800; box-shadow: 0 6px 0 #e65100;">æ¬¡ã¸</button>
  </div>
</div>

<div id="printable-sheet">
  <div class="sheet-header">
    <h1 class="sheet-title">Favorite Subjects (å¥½ããªæ•™ç§‘)</h1>
    <div style="text-align:right; font-size:11pt; margin-top:5px;">åå‰: ____________________ / æ—¥ä»˜: __________</div>
  </div>
  <div id="sheet-content"></div>
  <div class="answer-key-section">
    <h3 style="margin:0 0 15px 0;">è§£ç­” (Answer Key)</h3>
    <div id="sheet-answers"></div>
  </div>
</div>

<script>
  // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
  const allSubjects = ["science", "music", "math", "English", "art"];

  const originalData = [
    // --- ã€Part 1ã€‘ æœ€åˆã®5å•: 1ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ (é¸æŠè‚¢ã¯5æ•™ç§‘å…¨ã¦) ---
    {
      part: 1, type: 'cloze',
      q: "Erin likes (      ).",
      answer: "science",
      options: allSubjects, // 5æ•™ç§‘ã™ã¹ã¦ã‚’é¸æŠè‚¢ã«
      hint: "ã‚¨ãƒªãƒ³(ç†ç§‘)"
    },
    {
      part: 1, type: 'cloze',
      q: "Ken likes (      ).",
      answer: "music",
      options: allSubjects,
      hint: "ã‚±ãƒ³(éŸ³æ¥½)"
    },
    {
      part: 1, type: 'cloze',
      q: "Joe likes (      ).",
      answer: "art", // å°æ–‡å­—
      options: allSubjects,
      hint: "ã‚¸ãƒ§ãƒ¼(å›³å·¥)"
    },
    {
      part: 1, type: 'cloze',
      q: "Cindy likes (      ).",
      answer: "English",
      options: allSubjects,
      hint: "ã‚·ãƒ³ãƒ‡ã‚£(è‹±èª)"
    },
    {
      part: 1, type: 'cloze',
      q: "Kate likes (      ).",
      answer: "math",
      options: allSubjects,
      hint: "ã‚±ã‚¤ãƒˆ(ç®—æ•°)"
    },

    // --- ã€Part 2ã€‘ æ–‡æ³•ãƒ»èªå½™: 2ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ ---
    // (A) his / her / It's ã‚’å•ã†
    {
      part: 2, type: 'cloze',
      q: "Ken likes music.\n(      ) his favorite subject.",
      answer: "It's",
      options: ["It's", "He", "English", "She"],
      hint: "ã€Œãã‚Œã¯ã€œã§ã™ã€"
    },
    {
      part: 2, type: 'cloze',
      q: "Cindy likes English.\nIt's (      ) favorite subject.",
      answer: "her",
      options: ["her", "his", "she", "he"],
      hint: "Cindyã¯å¥³ã®å­ (å½¼å¥³ã®)"
    },
    {
      part: 2, type: 'cloze',
      q: "Joe likes art.\nIt's (      ) favorite subject.", 
      answer: "his",
      options: ["his", "her", "me", "you"],
      hint: "Joeã¯ç”·ã®å­ (å½¼ã®)"
    },

    // (B) favorite / likes / subject ã‚’å•ã†
    {
      part: 2, type: 'cloze',
      q: "Erin (      ) science.\nIt's her favorite subject.",
      answer: "likes",
      options: ["likes", "favorite", "subject", "English"],
      hint: "ã€Œã€œãŒå¥½ãã€"
    },
    {
      part: 2, type: 'cloze',
      q: "Ken likes music.\nIt's his (      ) subject.",
      answer: "favorite",
      options: ["favorite", "likes", "math", "music"],
      hint: "ã€Œä¸€ç•ªå¥½ããªã€"
    },
    {
      part: 2, type: 'cloze',
      q: "Kate likes math.\nIt's her favorite (      ).",
      answer: "subject",
      options: ["subject", "science", "likes", "English"],
      hint: "ã€Œæ•™ç§‘ã€"
    },

    // --- ã€Part 3ã€‘ ä¸¦ã¹æ›¿ãˆ ---
    {
      part: 3, type: 'sort',
      ja: "ã‚±ãƒ³ã¯éŸ³æ¥½ãŒå¥½ãã§ã™ã€‚",
      en: "Ken likes music."
    },
    {
      part: 3, type: 'sort',
      ja: "ã‚¸ãƒ§ãƒ¼ã¯å›³å·¥(ç¾è¡“)ãŒå¥½ãã§ã™ã€‚",
      en: "Joe likes art." // å°æ–‡å­—
    },
    {
      part: 3, type: 'sort',
      ja: "ãã‚Œã¯å½¼å¥³ã®ä¸€ç•ªå¥½ããªæ•™ç§‘ã§ã™ã€‚(Erin)",
      en: "It's her favorite subject."
    },
    {
      part: 3, type: 'sort',
      ja: "ãã‚Œã¯å½¼ã®ä¸€ç•ªå¥½ããªæ•™ç§‘ã§ã™ã€‚(Ken)",
      en: "It's his favorite subject."
    }
  ];

  let quizData = [];
  let currentQuestionIndex = 0;
  let currentWords = []; 
  let userSelection = []; 
  let selectedClozeOption = null;

  const questionText = document.getElementById('questionText');
  const questionNum = document.getElementById('questionNum');
  const questionType = document.getElementById('questionType');
  const clozeArea = document.getElementById('clozeArea');
  const sortArea = document.getElementById('sortArea');
  const choicesGrid = document.getElementById('choicesGrid');
  const answerArea = document.getElementById('answerArea');
  const wordBank = document.getElementById('wordBank');
  const resultMsg = document.getElementById('resultMsg');
  const checkBtn = document.getElementById('checkBtn');
  const nextBtn = document.getElementById('nextBtn');
  const progressBar = document.getElementById('progressBar');

  function shuffle(array) {
    let newArr = [...array];
    for (let i = newArr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
    }
    return newArr;
  }

  function initGame(isRestart = false) {
    const part1 = shuffle(originalData.filter(d => d.part === 1));
    const part2 = shuffle(originalData.filter(d => d.part === 2));
    const part3 = shuffle(originalData.filter(d => d.part === 3));
    quizData = [...part1, ...part2, ...part3];
    
    currentQuestionIndex = 0;
    resultMsg.textContent = "";
    checkBtn.style.display = "inline-block";
    nextBtn.style.display = "none";
    if(isRestart) alert("æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ï¼");
    loadQuestion();
    generatePrintSheet();
  }

  function loadQuestion() {
    if (currentQuestionIndex >= quizData.length) {
      finishGame();
      return;
    }
    userSelection = [];
    selectedClozeOption = null;
    resultMsg.textContent = "";
    resultMsg.className = "result-msg";
    checkBtn.style.display = "inline-block";
    checkBtn.disabled = false;
    nextBtn.style.display = "none";
    
    const progress = (currentQuestionIndex / quizData.length) * 100;
    progressBar.style.width = progress + "%";
    questionNum.textContent = `Question ${currentQuestionIndex + 1} / ${quizData.length}`;
    
    const q = quizData[currentQuestionIndex];
    if (q.type === 'cloze') {
        setupClozeQuestion(q);
    } else {
        setupSortQuestion(q);
    }
  }

  function setupClozeQuestion(q) {
      const partLabel = q.part === 1 ? "Part 1: ã‚¤ãƒ©ã‚¹ãƒˆã‚’è¦‹ã¦è¨€è‘‰ã‚’é¸ã¼ã†" : "Part 2: ç©´åŸ‹ã‚";
      questionType.textContent = partLabel;
      
      clozeArea.style.display = "flex";
      sortArea.style.display = "none";
      questionText.textContent = q.q;
      choicesGrid.innerHTML = "";
      shuffle(q.options).forEach(opt => {
          const btn = document.createElement('button');
          btn.className = "choice-btn";
          btn.textContent = opt;
          btn.onclick = () => selectClozeOption(btn, opt);
          choicesGrid.appendChild(btn);
      });
  }

  function selectClozeOption(btn, text) {
      if(nextBtn.style.display === "inline-block") return;
      document.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedClozeOption = text;
      const q = quizData[currentQuestionIndex];
      questionText.textContent = q.q.replace('(      )', `( ${text} )`);
  }

  function setupSortQuestion(q) {
      questionType.textContent = "Part 3: ä¸¦ã¹æ›¿ãˆ";
      clozeArea.style.display = "none";
      sortArea.style.display = "block";
      questionText.textContent = q.ja;

      let temp = q.en
          .replace(/Ms\./g, "Ms_DOT_")
          .replace(/Mr\./g, "Mr_DOT_")
          .replace(/Mrs\./g, "Mrs_DOT_")
          .replace(/Dr\./g, "Dr_DOT_");
      
      temp = temp.replace(/([.,?!])$/g, " $1"); 
      temp = temp.replace(/,/g, " ,");

      let words = temp.split(/\s+/).filter(w => w.length > 0);
      words = words.map(w => w.replace(/_DOT_/g, "."));

      currentWords = shuffle([...words]);
      renderWordBank();
      renderAnswerArea();
  }

  function renderWordBank() {
    wordBank.innerHTML = "";
    currentWords.forEach((word, index) => {
      const btn = document.createElement('button');
      btn.className = "word-btn";
      btn.textContent = word;
      if (userSelection.some(obj => obj.originalIndex === index)) {
        btn.classList.add('used');
      } else {
        btn.onclick = () => selectSortWord(word, index);
      }
      wordBank.appendChild(btn);
    });
  }

  function renderAnswerArea() {
    answerArea.innerHTML = "";
    if (userSelection.length === 0) {
      answerArea.innerHTML = '<span style="color:#8d6e63; font-size:1.2rem; align-self:center;">ã“ã“ã‚’æŠ¼ã—ã¦ ä¸¦ã¹ã¦ã­</span>';
      return;
    }
    userSelection.forEach((item, idx) => {
      const btn = document.createElement('button');
      btn.className = "answer-word";
      let displayText = item.text;
      if (idx === 0) {
          displayText = displayText.charAt(0).toUpperCase() + displayText.slice(1);
      }
      btn.textContent = displayText;
      btn.onclick = () => removeSortWord(idx); 
      answerArea.appendChild(btn);
    });
  }

  function selectSortWord(word, originalIndex) {
    userSelection.push({ text: word, originalIndex: originalIndex });
    renderWordBank();
    renderAnswerArea();
  }
  function removeSortWord(index) {
    userSelection.splice(index, 1);
    renderWordBank();
    renderAnswerArea();
  }

  function checkAnswer() {
    const q = quizData[currentQuestionIndex];
    let isCorrect = false;

    if (q.type === 'cloze') {
        if (!selectedClozeOption) {
            alert("ç­”ãˆã‚’é¸ã‚“ã§ã­ï¼");
            return;
        }
        isCorrect = (selectedClozeOption === q.answer);
        
        document.querySelectorAll('.choice-btn').forEach(btn => {
            if (isCorrect && btn.textContent === q.answer) {
                btn.classList.add('correct-choice');
            }
            else if (!isCorrect && btn.classList.contains('selected')) {
                btn.classList.add('wrong-choice');
            }
        });

    } else {
        if (userSelection.length === 0) { alert("è¨€è‘‰ã‚’é¸ã‚“ã§ã­ï¼"); return; }
        let userArr = userSelection.map(obj => obj.text);
        let userStr = userArr.join(" ");
        userStr = userStr.charAt(0).toUpperCase() + userStr.slice(1);
        let formatted = userStr.replace(/\s+([.,?!])/g, "$1");
        isCorrect = (formatted === q.en);
    }

    if (isCorrect) {
      resultMsg.textContent = "Good job! æ­£è§£ï¼";
      resultMsg.classList.add("correct");
      checkBtn.style.display = "none";
      nextBtn.style.display = "inline-block";
    } else {
      resultMsg.textContent = "Try again! ã‚‚ã†ä¸€å›ï¼";
      resultMsg.classList.add("wrong");
    }
  }

  function nextQuestion() {
    currentQuestionIndex++;
    loadQuestion();
  }

  function finishGame() {
    questionText.textContent = "All Done! å…¨éƒ¨ã§ããŸã­ï¼";
    questionNum.textContent = "Completed";
    questionType.style.display = "none";
    clozeArea.style.display = "none";
    sortArea.style.display = "none";
    answerArea.innerHTML = "ğŸ‰";
    resultMsg.textContent = "ã™ã”ã„ï¼";
    checkBtn.style.display = "none";
    nextBtn.style.display = "none";
    progressBar.style.width = "100%";
  }

  function generatePrintSheet() {
    const content = document.getElementById('sheet-content');
    const answers = document.getElementById('sheet-answers');
    content.innerHTML = ""; answers.innerHTML = "";
    
    let currentPart = 0;

    quizData.forEach((item, index) => {
      const qBlock = document.createElement('div');
      qBlock.className = 'sheet-question';
      
      if (item.part !== currentPart) {
          const h = document.createElement('div');
          h.className="sheet-section-title"; 
          if(item.part === 1) h.textContent = "Part 1: ã‚¤ãƒ©ã‚¹ãƒˆã‚’è¦‹ã¦è¨€è‘‰ã‚’é¸ã¼ã† (Look and Choose)";
          if(item.part === 2) h.textContent = "Part 2: ç©´åŸ‹ã‚ (Fill in the blanks)";
          if(item.part === 3) h.textContent = "Part 3: ä¸¦ã¹æ›¿ãˆ (Put the words in order)";
          content.appendChild(h);
          currentPart = item.part;
      }
      
      if (item.type === 'cloze') {
          const displayQ = item.q.replace(/\n/g, '<br>');
          qBlock.innerHTML = `<div class="q-text"><b>${index+1}.</b> ${displayQ}</div><div class="q-options">[ ${item.options.join(" / ")} ]</div>`;
      } else {
          let temp = item.en.replace(/Ms\./g,"Ms_").replace(/Mr\./g,"Mr_").replace(/Mrs\./g,"Mrs_").replace(/([.,?!])$/g," $1");
          let words = temp.split(/\s+/).filter(w=>w.length>0).map(w=>w.replace(/_/g,"."));
          let mixed = shuffle(words);
          
          qBlock.innerHTML = `<div class="q-text"><b>${index+1}.</b> ${item.ja}</div><div class="q-line"></div><div class="word-hint">( ${mixed.join(' / ')} )</div>`;
      }
      content.appendChild(qBlock);
      
      const aBlock = document.createElement('div');
      aBlock.innerHTML = `<b>${index+1}.</b> ${item.type==='cloze'?item.answer:item.en}`;
      answers.appendChild(aBlock);
    });
  }

  initGame();
</script>
</body>
</html>
